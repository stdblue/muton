# 2. 設計思想

muton はマルチスレッド実行を前提としたスクリプト実行環境です。
muton のスクリプトエンジンは複数の muton スクリプトエンジンによってオブジェクトの海を構成します。
スクリプトを実行するということは、スクリプトエンジンに対して並行実行可能な処理機を投げ込み、処理機が必要とするオブジェクトを収集し、加工します。

## 2.1 オブジェクトのメモリ空間（Object memory space）

muton スクリプトエンジン（mutonse）はオブジェクトのメモリ空間を持っており、処理を適用するごとに、実行前と実行後のオブジェクト更新を保持します。
シーングラフのように処理によるオブジェクトのツリーが作成されるため、これをオブジェクトグラフと呼称します。

このオブジェクトグラフは不要な処理がUndoバッファーとしてメモリ空間上に保持されているため、この現在のオブジェクトグラフを確定するために commit を実行し、不要メモリを削除します。

スクリプトはスクリプトエンジン上のメモリ空間を使用し、実行されます。
以下のスクリプトはスクリプトエンジン上のメモリ空間に変数 i を作成します。
~~~
var i = 0;
~~~
このスクリプトは `mutonse.スクリプトエンジンID.anonymous_script_GUID.i` という変数をスクリプトエンジン内に作成します。
この変数は一時変数のため、スクリプト実行後に解放されます。

もし、スクリプト内で作成した変数をスクリプト終了後も保持したい場合には、モジュール宣言を行い、独自のメモリ空間を持つことを宣言します。
~~~
module my.programs.memory.space
{
    var count = 0;
}
~~~

このモジュール宣言によって、変数 count はスクリプトエンジンの提供する一時オブジェクトではなく、`my.programs.memory.space` メモリ空間内の変数となります。
そして、スクリプト実行後も削除されることなく、スクリプトエンジン内に `my.programs.memory.space.count` として保持されます。

## 2.2 スクリプトの実行（Execution of script）

muton のスクリプトとは、スクリプトエンジン中のメモリ空間のオブジェクトを参照し、加工し、適用する、という手順で実行されます。
そのため、すべてのスクリプトはブロック化され、どのオブジェクトに副作用を及ぼすのか、スクリプト実行前に明確化します。

スクリプトの実行は以下の手順で実施されます。

1. 記述されているスクリプトをブロック化する。
2. ブロックの外部に存在するメモリ空間から参照するオブジェクトを明確化する。
3. ブロックの外部に存在するメモリ空間に加工するオブジェクトを明確化する。
4. オブジェクトグラフにコピーする。
5. スクリプトブロックを実行する。
6. オブジェクトグラフに出力となるオブジェクトをアタッチする。

スクリプトは実行単位によってブロック化されます。
この実行単位ごとに処理機が生成され、スレッドプールから実行用のスレッドを取得し、処理を行います。

スクリプトのブロック化はコードのブロックと一致します。
以下のようなコードがあるとします。
~~~
var i=0;
i = i+5;

while ( i < 10 )
{
    i = i + 1;
}
~~~

このコードは次のようにブロック化されます。
~~~
// 第1ブロック
{
    init
    {
        var mutonse.スクリプトエンジンID.anonymous_script_GUID.i : integer;
    }

    body
    {
        i = 0;
        i = i+5;
    }

    finish
    {
        [out] mutonse.スクリプトエンジンID.anonymous_script_GUID.i;
    }
}
// 第2ブロック
{
    init
    {
        [in] mutonse.スクリプトエンジンID.anonymous_script_GUID.i;
    }

    before_loop_condition ( i < 10 );

    body
    {
        i = i + 1;
    }

    after_loop_condition (true);

    finish
    {
        [out] mutonse.スクリプトエンジンID.anonymous_script_GUID.i;
    }
}
~~~

スクリプトは二つの処理機に分割され、実行されます。
ループ処理はブロック汎用処理に展開しています。
上記のコードでは2つのブロックが2つのスレッドに渡され、同時に実行されます。
ただし、第2ブロックでは変数を入力として参照することをブロック初期化処理時に宣言しています。
そのため、第1ブロックで変数が生成されるまで、第2ブロックは処理の実行を待機します。

muton のブロック処理はアクセスする変数（オブジェクト）単位でブロック処理を行うため、パフォーマンスの劣化は避けられません。

## 2.3 ブロック汎用処理（Warding）


　